---
import AppLayout from "../layouts/AppLayout.astro";
---

<AppLayout
    title="Punto de Venta"
    description="Interfaz de Punto de Venta para procesar transacciones r√°pidas, gestionar carritos y registrar ventas.">
    <div class="grid h-[calc(100vh-8rem)] grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Products Section -->
        <div class="lg:col-span-2 min-h-0">
            <div class="flex h-full flex-col rounded-lg bg-white shadow">
                <div class="border-b border-gray-200 p-4">
                    <h3 class="text-lg font-medium text-gray-900">Productos</h3>
                    <div class="mt-2">
                        <input
                            type="text"
                            id="product-search"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                            placeholder="üîç Buscar producto..."
                            autofocus
                        />
                    </div>
                </div>
                <div
                    id="products-list"
                    class="grid flex-1 content-start grid-cols-2 gap-4 overflow-y-auto p-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
                    <!-- Product cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- Cart Section -->
        <div class="min-h-0">
            <div class="flex h-full flex-col rounded-lg bg-white shadow">
                <div class="border-b border-gray-200 p-4">
                    <h3 class="text-lg font-medium text-gray-900">Carrito</h3>
                </div>
                <div
                    id="cart-items"
                    class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Cart items will be injected here -->
                </div>
                <div
                    class="border-t border-gray-200 p-4 bg-gray-50 rounded-b-lg">
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Subtotal</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div
                            class="flex items-center justify-between text-sm text-gray-500">
                            <label for="discount">Descuento</label>
                            <input
                                type="number"
                                id="discount"
                                value="0"
                                min="0"
                                step="0.01"
                                class="w-24 rounded-md border-gray-300 text-right shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                            />
                        </div>
                        <div
                            class="flex justify-between text-lg font-bold text-gray-900">
                            <span>Total</span>
                            <span id="total">$0.00</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label
                            for="payment-method"
                            class="block text-sm font-medium text-gray-700"
                            >M√©todo de Pago</label
                        >
                        <select
                            id="payment-method"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="EFECTIVO">Efectivo</option>
                            <option value="DEBITO">D√©bito</option>
                            <option value="CREDITO">Cr√©dito</option>
                            <option value="TRANSFERENCIA">Transferencia</option>
                        </select>
                    </div>
                    <div class="mt-6">
                        <button
                            id="complete-sale-btn"
                            disabled
                            class="w-full rounded-md border border-transparent bg-indigo-600 px-4 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:bg-gray-300 transition-colors">
                            Completar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ticket Modal -->
        <div
            id="ticket-modal"
            class="fixed inset-0 z-10 hidden overflow-y-auto bg-gray-500 bg-opacity-75">
            <div
                class="flex min-h-screen items-center justify-center p-4 text-center">
                <div
                    class="relative w-full max-w-sm transform rounded-lg bg-white p-6 text-left shadow-xl transition-all">
                    <button
                        id="close-ticket"
                        class="absolute right-2 top-2 rounded-md p-1 text-gray-400 hover:bg-gray-100">
                        &times;
                    </button>
                    <div id="ticket-content"></div>
                    <div class="mt-6 flex justify-center space-x-3">
                        <button
                            id="new-sale"
                            class="w-full rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 transition-colors">
                            Nueva Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        .ticket-modal {
            max-width: 400px;
            padding: 2rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #64748b;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #0f172a;
            transform: scale(1.1);
        }

        .ticket {
            font-family: "Courier Prime", "Courier New", monospace;
            padding: 20px;
            background: #fff;
            width: 100%;
            max-width: 380px;
            margin: 0 auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            color: #2d2d2d;
        }

        /* Jagged edge effect top and bottom */
        .ticket::before,
        .ticket::after {
            content: "";
            position: absolute;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: #fff;
            -webkit-mask-image: radial-gradient(
                circle at 10px 15px,
                transparent 10px,
                black 11px
            );
            mask-image: radial-gradient(
                circle at 10px 15px,
                transparent 10px,
                black 11px
            );
            -webkit-mask-size: 20px 20px;
            mask-size: 20px 20px;
            -webkit-mask-repeat: repeat-x;
            mask-repeat: repeat-x;
        }

        .ticket::before {
            top: -10px;
            transform: rotate(180deg);
        }

        .ticket::after {
            bottom: -10px;
        }

        .ticket-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .ticket-logo {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .ticket-title {
            font-size: 1.2rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.2rem;
            border-bottom: 2px solid #000;
            display: inline-block;
            padding-bottom: 2px;
        }

        .ticket-business {
            font-size: 1rem;
            font-weight: 700;
            margin: 0.5rem 0;
            text-transform: uppercase;
        }

        .ticket-business-info {
            font-size: 0.75rem;
            color: #555;
            line-height: 1.4;
        }

        .ticket-divider {
            border-top: 1px dashed #000;
            margin: 1rem 0;
        }

        .ticket-info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .ticket-info-label {
            font-weight: 700;
            color: #555;
        }

        .ticket-info-value {
            text-align: right;
            font-weight: 600;
        }

        .ticket-items-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .ticket-items-table th {
            text-align: left;
            border-bottom: 2px solid #000;
            padding-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.7rem;
        }

        .ticket-items-table td {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #ccc;
            vertical-align: top;
        }

        .ticket-items-table td:last-child,
        .ticket-items-table th:last-child {
            text-align: right;
        }

        .ticket-item-name {
            font-weight: 600;
            display: block;
            margin-bottom: 0.2rem;
        }

        .ticket-item-meta {
            font-size: 0.7rem;
            color: #666;
        }

        .ticket-totals {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 2px solid #000;
        }

        .ticket-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .ticket-total-row.final {
            font-size: 1.5rem;
            font-weight: 900;
            margin-top: 0.5rem;
            border-top: 1px dashed #000;
            padding-top: 0.5rem;
        }

        .ticket-footer {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.8rem;
            color: #555;
        }

        .ticket-barcode {
            margin: 1.5rem 0;
            text-align: center;
        }

        .ticket-barcode-img {
            height: 50px;
            width: 80%;
            background: repeating-linear-gradient(
                90deg,
                #000,
                #000 2px,
                #fff 2px,
                #fff 4px
            );
            margin: 0 auto;
        }

        .ticket-barcode-num {
            font-family: monospace;
            letter-spacing: 4px;
            margin-top: 0.2rem;
            font-size: 0.8rem;
        }

        .ticket-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .ticket-actions .btn {
            flex: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @media print {
            /* Ocultar absolutamente todo primero */
            body * {
                visibility: hidden !important;
                display: none !important;
            }

            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Ocultar expl√≠citamente el layout */
            .app-layout,
            .navbar,
            .navbar *,
            .main-content,
            .container,
            .pos-container,
            .pos-grid {
                display: none !important;
                visibility: hidden !important;
            }

            /* Mostrar SOLO el modal del ticket */
            #ticket-modal {
                display: block !important;
                visibility: visible !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                z-index: 99999 !important;
            }

            #ticket-modal,
            #ticket-modal *,
            #ticket-content,
            #ticket-content * {
                visibility: visible !important;
                display: block !important;
            }

            #ticket-modal .modal-content {
                box-shadow: none !important;
                border: none !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            /* Ocultar botones y cerrar */
            .modal-close,
            .ticket-actions,
            .modal-close *,
            .ticket-actions *,
            #close-ticket,
            #print-ticket,
            #new-sale,
            button {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                height: 0 !important;
                width: 0 !important;
                overflow: hidden !important;
            }

            /* Estilos del ticket para impresi√≥n */
            .ticket {
                position: static !important;
                border: none !important;
                box-shadow: none !important;
                margin: 0 auto !important;
                padding: 20px !important;
                background: white !important;
                max-width: 320px !important;
            }
        }
    </style>

    <script>
        import { api } from "../lib/api";

        const currentBusiness = JSON.parse(
            localStorage.getItem("currentBusiness") || "{}"
        );

        if (!currentBusiness.id) {
            window.location.href = "/businesses";
        }

        let products: any[] = [];
        let cart: any[] = [];
        let cashRegisterId: string | null = null;

        async function loadProducts(search = "") {
            try {
                products = await api.getProducts(currentBusiness.id, search);
                renderProducts();
            } catch (error) {
                console.error("Error loading products:", error);
            }
        }

        function renderProducts() {
            const container = document.getElementById("products-list");
            if (!container) return;

            container.innerHTML = products
                .map(
                    (product) => `
      <div class="product-card" data-product-id="${product.id}" style="background: white; border: none; border-radius: 0; padding: 1.25rem; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); position: relative; user-select: none; box-shadow: none;">
        <div class="product-name" style="font-weight: 700; font-size: 1rem; color: #0f172a; margin-bottom: 0.75rem; line-height: 1.4; min-height: 2.8em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${product.name}</div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto;">
          <div class="product-price" style="font-weight: 800; font-size: 1.5rem; color: #6366f1; letter-spacing: -0.03em;">$${product.price.toFixed(2)}</div>
          <div class="product-stock" style="font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 0.25rem 0.625rem; border-radius: 0.375rem; font-weight: 600;">üì¶ ${product.stock}</div>
        </div>
      </div>
    `
                )
                .join("");

            container.querySelectorAll(".product-card").forEach((card) => {
                const htmlCard = card as HTMLElement;

                // Eventos de hover
                htmlCard.addEventListener("mouseenter", () => {
                    htmlCard.style.transform = "translateY(-8px) scale(1.05)";
                    htmlCard.style.zIndex = "10";
                });

                htmlCard.addEventListener("mouseleave", () => {
                    htmlCard.style.transform = "translateY(0) scale(1)";
                    htmlCard.style.zIndex = "1";
                });

                htmlCard.addEventListener("click", () => {
                    const productId = htmlCard.getAttribute("data-product-id");
                    const product = products.find((p) => p.id === productId);
                    if (product) {
                        addToCart(product);

                        // Visual feedback
                        htmlCard.classList.add("product-added");
                        setTimeout(
                            () => htmlCard.classList.remove("product-added"),
                            600
                        );
                    }
                });
            });
        }

        function addToCart(product: any) {
            const existing = cart.find(
                (item) => item.product_id === product.id
            );
            if (existing) {
                if (existing.quantity < product.stock) {
                    existing.quantity++;
                }
            } else {
                if (product.stock > 0) {
                    cart.push({
                        product_id: product.id,
                        name: product.name,
                        unit_price: product.price,
                        quantity: 1,
                    });
                }
            }
            renderCart();

            // Auto-scroll to bottom of cart
            const cartContainer = document.getElementById("cart-items");
            if (cartContainer) {
                setTimeout(() => {
                    cartContainer.scrollTop = cartContainer.scrollHeight;
                }, 50);
            }
        }

        function renderCart() {
            const container = document.getElementById("cart-items");
            if (!container) return;

            if (cart.length === 0) {
                container.innerHTML = `
                <div class="empty-cart">
                    <div class="empty-cart-icon">üõí</div>
                    <div class="empty-cart-text">Carrito vac√≠o</div>
                    <div class="empty-cart-hint">Selecciona productos para agregar</div>
                </div>
            `;
            } else {
                container.innerHTML = cart
                    .map(
                        (item, index) => `
        <div class="cart-item">
          <div class="cart-item-info">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">$${item.unit_price.toFixed(2)}</div>
          </div>
          <div class="cart-item-qty">
            <button class="qty-btn" data-action="decrease" data-index="${index}">-</button>
            <span>${item.quantity}</span>
            <button class="qty-btn" data-action="increase" data-index="${index}">+</button>
          </div>
          <button class="btn-danger btn-sm" data-action="remove" data-index="${index}">√ó</button>
        </div>
      `
                    )
                    .join("");

                // Add event listeners
                container.querySelectorAll("[data-action]").forEach((btn) => {
                    btn.addEventListener("click", (e) => {
                        const target = e.currentTarget as HTMLElement;
                        const action = target.getAttribute("data-action");
                        const index = parseInt(
                            target.getAttribute("data-index") || "0"
                        );

                        if (action === "decrease") {
                            if (cart[index].quantity > 1) {
                                cart[index].quantity--;
                            }
                        } else if (action === "increase") {
                            cart[index].quantity++;
                        } else if (action === "remove") {
                            cart.splice(index, 1);
                        }

                        renderCart();
                    });
                });
            }

            updateTotals();
        }

        function updateTotals() {
            const subtotal = cart.reduce(
                (sum, item) => sum + item.quantity * item.unit_price,
                0
            );
            const discount = parseFloat(
                (document.getElementById("discount") as HTMLInputElement)
                    ?.value || "0"
            );
            const total = subtotal - discount;

            document.getElementById("subtotal")!.textContent =
                `$${subtotal.toFixed(2)}`;
            document.getElementById("total")!.textContent =
                `$${total.toFixed(2)}`;

            const completeBtn = document.getElementById(
                "complete-sale-btn"
            ) as HTMLButtonElement;
            completeBtn.disabled = cart.length === 0;
        }

        async function checkCashRegister() {
            try {
                const cashRegister = await api.getCurrentCash(
                    currentBusiness.id
                );
                cashRegisterId = cashRegister.id;
            } catch (error) {
                // No open cash register
                cashRegisterId = null;
            }
        }

        document
            .getElementById("product-search")
            ?.addEventListener("input", (e) => {
                const search = (e.target as HTMLInputElement).value;
                loadProducts(search);
            });

        document
            .getElementById("discount")
            ?.addEventListener("input", updateTotals);

        function showTicket(saleData: any) {
            const subtotal = cart.reduce(
                (sum, item) => sum + item.unit_price * item.quantity,
                0
            );
            const discount = parseFloat(
                (document.getElementById("discount") as HTMLInputElement)
                    .value || "0"
            );
            const total = subtotal - discount;
            const now = new Date();

            // Formatear fecha y hora
            const fecha = now.toLocaleDateString("es-ES", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
            });
            const hora = now.toLocaleTimeString("es-ES", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
            });

            // N√∫mero de ticket
            const ticketNumber = Date.now().toString().slice(-8);

            // Generar c√≥digo de barras simulado (l√≠neas aleatorias)
            const barcodeLines = Array(30)
                .fill(0)
                .map(() => {
                    const rand = Math.random();
                    if (rand < 0.3)
                        return '<div class="ticket-barcode-line thick"></div>';
                    if (rand < 0.6)
                        return '<div class="ticket-barcode-line"></div>';
                    return '<div class="ticket-barcode-line" style="width: 1px;"></div>';
                })
                .join("");

            const ticketHTML = `
            <div class="ticket">
                <div class="ticket-header">
                    <div class="ticket-logo">üè™</div>
                    <div class="ticket-title">Comprobante de Venta</div>
                    <div class="ticket-business">${currentBusiness.name}</div>
                    <div class="ticket-business-info">
                        üìç Calle Principal #123<br>
                        üìû (555) 123-4567<br>
                        üÜî RFC/CUIT: XX-XXXXX-XXX
                    </div>
                </div>
                
                <div class="ticket-divider"></div>
                
                <div class="ticket-info-grid">
                    <span class="ticket-info-label">Ticket No.:</span>
                    <span class="ticket-info-value">#${ticketNumber}</span>
                    
                    <span class="ticket-info-label">Fecha:</span>
                    <span class="ticket-info-value">${fecha}</span>
                    
                    <span class="ticket-info-label">Hora:</span>
                    <span class="ticket-info-value">${hora}</span>
                    
                    <span class="ticket-info-label">Atendi√≥:</span>
                    <span class="ticket-info-value">Usuario POS</span>
                </div>
                
                <div class="ticket-divider"></div>
                
                <table class="ticket-items-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant</th>
                            <th>P.Unit</th>
                            <th>Importe</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cart
                            .map(
                                (item) => `
                            <tr>
                                <td>
                                    <span class="ticket-item-name">${item.name}</span>
                                    <span class="ticket-item-meta">ID: ${item.product_id.slice(0, 6)}</span>
                                </td>
                                <td>${item.quantity}</td>
                                <td>$${item.unit_price.toFixed(2)}</td>
                                <td>$${(item.unit_price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `
                            )
                            .join("")}
                    </tbody>
                </table>
                
                <div class="ticket-totals">
                    <div class="ticket-total-row">
                        <span>Subtotal</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    ${
                        discount > 0
                            ? `
                    <div class="ticket-total-row">
                        <span>Descuento</span>
                        <span>-$${discount.toFixed(2)}</span>
                    </div>
                    `
                            : ""
                    }
                    <div class="ticket-total-row final">
                        <span>TOTAL</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="ticket-divider"></div>

                <div class="ticket-info-grid" style="margin-bottom: 0;">
                    <span class="ticket-info-label">Forma de Pago:</span>
                    <span class="ticket-info-value">${saleData.payment_method}</span>
                </div>
                
                <div class="ticket-barcode">
                    <div class="ticket-barcode-img"></div>
                    <div class="ticket-barcode-num">${ticketNumber}</div>
                </div>
                
                <div class="ticket-footer">
                    <p>¬°Gracias por su compra!</p>
                    <p style="margin-top: 0.5rem; font-size: 0.7rem;">Este documento no es v√°lido como comprobante fiscal</p>
                </div>
            </div>
        `;

            document.getElementById("ticket-content")!.innerHTML = ticketHTML;
            document.getElementById("ticket-modal")!.style.display = "flex";
        }

        document
            .getElementById("complete-sale-btn")
            ?.addEventListener("click", async () => {
                if (cart.length === 0) return;

                const completeBtn = document.getElementById(
                    "complete-sale-btn"
                ) as HTMLButtonElement;
                const originalContent = completeBtn.innerHTML;

                try {
                    completeBtn.disabled = true;
                    completeBtn.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Procesando...
                    `;

                    const discount = parseFloat(
                        (
                            document.getElementById(
                                "discount"
                            ) as HTMLInputElement
                        ).value || "0"
                    );
                    const paymentMethod = (
                        document.getElementById(
                            "payment-method"
                        ) as HTMLSelectElement
                    ).value;

                    const saleData = {
                        business_id: currentBusiness.id,
                        items: cart,
                        discount,
                        payment_method: paymentMethod,
                        cash_register_id: cashRegisterId,
                    };

                    await api.createSale(saleData);

                    showTicket(saleData);
                } catch (error: any) {
                    alert("Error al completar la venta: " + error.message);
                } finally {
                    completeBtn.disabled = false;
                    completeBtn.innerHTML = originalContent;
                }
            });

        document
            .getElementById("close-ticket")
            ?.addEventListener("click", () => {
                document.getElementById("ticket-modal")!.style.display = "none";
            });

        document.getElementById("new-sale")?.addEventListener("click", () => {
            document.getElementById("ticket-modal")!.style.display = "none";
            cart = [];
            renderCart();
            loadProducts();
            (document.getElementById("discount") as HTMLInputElement).value =
                "0";
        });

        checkCashRegister();
        loadProducts();
    </script>
</AppLayout>
