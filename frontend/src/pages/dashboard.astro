---
import AppLayout from "../layouts/AppLayout.astro";
---

<AppLayout
    title="Dashboard"
    description="Panel de control del Sistema POS: estadísticas de ventas, productos más vendidos y actividad reciente.">
    <div class="space-y-8">
        <!-- Stats Grid -->
        <div
            id="stats-grid"
            class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Recent Sales and Low Stock -->
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
            <div class="lg:col-span-2">
                <div class="rounded-lg bg-white p-6 shadow">
                    <h3 class="text-lg font-medium text-gray-900">
                        Ventas Recientes
                    </h3>
                    <div id="recent-sales" class="mt-4"></div>
                </div>
            </div>
            <div>
                <div class="rounded-lg bg-white p-6 shadow">
                    <h3 class="text-lg font-medium text-gray-900">
                        Productos con Bajo Stock
                    </h3>
                    <div id="low-stock" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>
</AppLayout>

<script>
    import { api } from "../lib/api";

    const currentBusiness = JSON.parse(
        localStorage.getItem("currentBusiness") || "{}"
    );

    if (!currentBusiness.id) {
        window.location.href = "/businesses";
    }

    async function loadDashboard() {
        try {
            const stats = await api.getDashboardStats(currentBusiness.id);

            const statsGrid = document.getElementById("stats-grid");
            if (statsGrid) {
                statsGrid.innerHTML = `
          <div class="stat-card rounded-lg bg-white p-6 shadow">
            <div class="stat-label text-sm font-semibold text-gray-500">Ventas Hoy</div>
            <div class="stat-value text-3xl font-bold text-gray-900">${stats.today.sales_count}</div>
            <div class="stat-label text-sm font-semibold text-gray-500">$${stats.today.total.toFixed(2)}</div>
          </div>
          <div class="stat-card rounded-lg bg-white p-6 shadow">
            <div class="stat-label text-sm font-semibold text-gray-500">Ventas del Mes</div>
            <div class="stat-value text-3xl font-bold text-gray-900">${stats.month.sales_count}</div>
            <div class="stat-label text-sm font-semibold text-gray-500">$${stats.month.total.toFixed(2)}</div>
          </div>
          <div class="stat-card rounded-lg bg-white p-6 shadow">
            <div class="stat-label text-sm font-semibold text-gray-500">Productos Activos</div>
            <div class="stat-value text-3xl font-bold text-gray-900">${stats.active_products_count}</div>
          </div>
          <div class="stat-card rounded-lg bg-white p-6 shadow">
            <div class="stat-label text-sm font-semibold text-gray-500">Stock Bajo</div>
            <div class="stat-value text-3xl font-bold text-gray-900">${stats.low_stock_count}</div>
          </div>
        `;
            }

            // Load recent sales
            const sales = await api.getSales(currentBusiness.id, 5);
            const recentSalesDiv = document.getElementById("recent-sales");
            if (recentSalesDiv) {
                if (sales.length === 0) {
                    recentSalesDiv.innerHTML =
                        '<p class="loading">No hay ventas recientes</p>';
                } else {
                    recentSalesDiv.innerHTML = `
            <div class="table-container">
              <table class="table w-full">
                <thead>
                  <tr class="bg-gray-100 text-gray-700">
                    <th class="py-2 text-left text-sm font-medium">Fecha</th>
                    <th class="py-2 text-left text-sm font-medium">Total</th>
                    <th class="py-2 text-left text-sm font-medium">Método</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${sales
                      .map(
                          (sale: any) => `
                    <tr class="hover:bg-gray-50">
                      <td class="py-3 text-sm">${new Date(sale.created_at).toLocaleDateString()}</td>
                      <td class="py-3 text-sm">$${sale.total.toFixed(2)}</td>
                      <td class="py-3 text-sm"><span class="badge badge-info">${sale.payment_method}</span></td>
                    </tr>
                  `
                      )
                      .join("")}
                </tbody>
              </table>
            </div>
          `;
                }
            }

            // Load low stock
            const lowStock = await api.getLowStock(currentBusiness.id);
            const lowStockDiv = document.getElementById("low-stock");
            if (lowStockDiv) {
                if (lowStock.length === 0) {
                    lowStockDiv.innerHTML =
                        '<p class="loading">Todos los productos tienen stock suficiente</p>';
                } else {
                    lowStockDiv.innerHTML = `
            <div class="table-container">
              <table class="table w-full">
                <thead>
                  <tr class="bg-gray-100 text-gray-700">
                    <th class="py-2 text-left text-sm font-medium">Producto</th>
                    <th class="py-2 text-left text-sm font-medium">Stock</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${lowStock
                      .map(
                          (product: any) => `
                    <tr class="hover:bg-gray-50">
                      <td class="py-3 text-sm">${product.name}</td>
                      <td class="py-3 text-sm"><span class="badge badge-warning">${product.stock}</span></td>
                    </tr>
                  `
                      )
                      .join("")}
                </tbody>
              </table>
            </div>
          `;
                }
            }
        } catch (error) {
            console.error("Error loading dashboard:", error);
        }
    }

    loadDashboard();
</script>

<style>
    .loading {
        text-align: center;
        padding: 3rem;
        color: var(--text-light);
        font-size: 0.9375rem;
    }
</style>
