---
import AuthLayout from "../layouts/AuthLayout.astro";
---

<AuthLayout
    title="Iniciar Sesi√≥n"
    description="Accede a tu cuenta del Sistema POS para gestionar ventas, productos e inventario.">
    <div class="space-y-6">
        <h2 class="text-center text-2xl font-bold text-gray-900">
            Iniciar Sesi√≥n
        </h2>

        <!-- Demo credentials banner -->
        <div class="rounded-md bg-blue-50 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <span class="text-2xl">üéØ</span>
                </div>
                <div class="ml-3 flex-1 md:flex md:justify-between">
                    <p class="text-sm text-blue-700">
                        <strong class="font-bold">Credenciales de Demo:</strong>
                        <span
                            class="credential-item ml-2 cursor-pointer"
                            data-tooltip="Click para copiar"
                            >üìß demo@pos.com</span
                        >
                        <span
                            class="credential-item ml-2 cursor-pointer"
                            data-tooltip="Click para copiar">üîë demo123</span
                        >
                    </p>
                </div>
            </div>
        </div>

        <form id="login-form" class="space-y-6">
            <div>
                <label
                    for="email"
                    class="block text-sm font-medium text-gray-700"
                    >Correo electr√≥nico</label
                >
                <div class="mt-1">
                    <input
                        type="email"
                        id="email"
                        required
                        class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm"
                        placeholder="tu@email.com"
                        value="demo@pos.com"
                    />
                </div>
            </div>

            <div>
                <label
                    for="password"
                    class="block text-sm font-medium text-gray-700"
                    >Contrase√±a</label
                >
                <div class="mt-1">
                    <input
                        type="password"
                        id="password"
                        required
                        class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        value="demo123"
                    />
                </div>
            </div>

            <div class="flex items-center justify-between">
                <div class="text-sm">
                    <a
                        href="/register"
                        class="font-medium text-indigo-600 hover:text-indigo-500"
                        >¬øNo tienes cuenta? Reg√≠strate</a
                    >
                </div>
            </div>

            <div
                id="error-message"
                class="hidden rounded-md bg-red-50 p-4 text-sm text-red-700">
            </div>

            <div>
                <button
                    type="submit"
                    class="flex w-full justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <span class="btn-text">Iniciar Sesi√≥n</span>
                    <div class="spinner hidden"></div>
                </button>
            </div>
        </form>
    </div>
</AuthLayout>

<script>
    import { api } from "../lib/api";

    const form = document.getElementById("login-form") as HTMLFormElement;
    const errorMessage = document.getElementById(
        "error-message"
    ) as HTMLDivElement;

    // Copy credentials on click
    const credentialItems = document.querySelectorAll(".credential-item");
    credentialItems.forEach((item) => {
        item.addEventListener("click", async () => {
            const text = item.textContent?.split(" ")[1] || "";
            await navigator.clipboard.writeText(text);

            // Visual feedback
            item.classList.add("copied");
            const originalTooltip = item.getAttribute("data-tooltip");
            item.setAttribute("data-tooltip", "¬°Copiado! ‚úì");

            setTimeout(() => {
                item.classList.remove("copied");
                item.setAttribute("data-tooltip", originalTooltip || "");
            }, 1500);
        });
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = (document.getElementById("email") as HTMLInputElement)
            .value;
        const password = (
            document.getElementById("password") as HTMLInputElement
        ).value;

        try {
            errorMessage.style.display = "none";
            const button = form.querySelector(
                'button[type="submit"]'
            ) as HTMLButtonElement;
            button.disabled = true;
            button.classList.add("btn-loading");

            // Keep button text visible during loading
            const originalText = button.textContent;
            button.innerHTML =
                '<span style="opacity: 0.7;">Ingresando...</span>';

            const response = await api.login(email, password);

            localStorage.setItem("accessToken", response.accessToken);
            localStorage.setItem("refreshToken", response.refreshToken);
            localStorage.setItem("user", JSON.stringify(response.user));

            button.innerHTML =
                '<span style="opacity: 0.7;">‚úì Redirigiendo...</span>';

            setTimeout(() => {
                window.location.href = "/dashboard";
            }, 300);
        } catch (error: any) {
            errorMessage.textContent =
                error.message || "Error al iniciar sesi√≥n";
            errorMessage.style.display = "flex";
            errorMessage.style.alignItems = "center";
            errorMessage.style.gap = "0.5rem";
            errorMessage.innerHTML = `<span style="font-size: 1.25rem;">‚ö†Ô∏è</span> ${errorMessage.textContent}`;

            const button = form.querySelector(
                'button[type="submit"]'
            ) as HTMLButtonElement;
            button.disabled = false;
            button.classList.remove("btn-loading");
            button.textContent = "Ingresar";

            // Shake animation for error
            form.classList.add("shake");
            setTimeout(() => form.classList.remove("shake"), 500);
        }
    });
</script>

<style>
    @keyframes shake {
        0%,
        100% {
            transform: translateX(0);
        }
        25% {
            transform: translateX(-10px);
        }
        75% {
            transform: translateX(10px);
        }
    }

    .shake {
        animation: shake 0.5s ease-in-out;
    }
</style>
